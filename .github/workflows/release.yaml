name: Push release

env:
  ONLINE_REGISTER: ghcr.io
  BUILD_PLATFORM: linux/amd64,linux/arm64
  ONLINE_REGISTER_USER: ${{ github.actor }}
  ONLINE_REGISTER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

on:
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      ref:
        description: 'tag, sha, branch'
        required: true
        default: v1.0.0
jobs:
  call-workflow:
    uses: ./.github/workflows/bin-build.yaml
    with:
      ref: ${{ github.event.inputs.ref }}
    secrets: inherit

  create-release:
    runs-on: ubuntu-latest
    name: Create Release
    needs: call-workflow
    steps:
      - name: Get Release Tag
        id: get_ref
        run: |
          if ${{ github.event_name == 'workflow_dispatch' }} ; then
              echo "call by self workflow_dispatch"
              echo ::set-output name=ref::${{ github.event.inputs.ref }}
          elif ${{ github.event_name == 'push' }} ; then
              echo "call by tag push"
              echo ::set-output name=ref::${GITHUB_REF##*/}
          else
            echo "unexpected event: ${{ github.event_name }}"
            exit 1
          fi

      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: binary_files
          path: ./

      - name: Create Release
        id: create_release
        uses: ncipollo/release-action@v1.9.0
        with:
          artifacts: "./plugins.tar"
          allowUpdates: true
          removeArtifacts: true
          replacesArtifacts: true
          artifactErrorsFailBuild: true
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.get_ref.outputs.ref }}
          name: "Release ${{ steps.get_ref.outputs.ref }}"
